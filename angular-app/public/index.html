<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<link rel="stylesheet" href="/css/bootstrap.min.css" />
	</head>
	<body ng-controller="AppController">
		<ul class="list-unstyled">
			<li ng-repeat="msg in Messages | orderBy:'created_at'">
				<strong>{{ msg.user }}:</strong> {{ msg.text }}<br />
				<small>at {{ msg.created_at | date:'yyyy-MM-dd hh:ss' }}</small>
			</li>
		</ul>

		<input ng-model="user.name" placeholder="Enter your name" />
		<input ng-model="msg" placeholder="Enter a message" />
		<button type="button" ng-click="sendMessage(msg)">Send Message</button>

		<iframe mrt-bridge src="http://localhost:3000"></iframe>

		<script type="text/javascript" src="/js/angular.min.js"></script>
		<script type="text/javascript" src="/js/meteor-bridge.js"></script>
		<script type="text/javascript">
			var app = angular.module('bridgeTest', [ 'ngMeteorBridge' ])
			
			app.controller('AppController', [
				'$scope', 'bridge',
				function ($scope, bridge) {
					$scope.user = {};

					function inColl(a,key,val) {
						var len = a.length;
						for(var i=0;i<len;i++) {
							if(a[i][key]==val) {
								return i;
							}
						}
						return -1;
					}

					$scope.sendMessage = function(text) {
						var msg = {},
							rpc = {
								fn: 'insert',
								args: [ 'Messages', msg ]
							};

						console.log('setting message on channel', msg);

						msg.text = text;
						msg.user = $scope.user.name || 'anonymous';
						
						bridge.channel = rpc;

						delete $scope.msg;
					};

					window.onmessage = function(e) {
						var msg = e.data,
							mdl = $scope[msg.coll];

						console.log('message from server', msg);

						if(!mdl) {
							mdl = $scope[msg.coll] = [];
						}

						switch(msg.op) {
							case 'added':
								if(inColl(mdl,'_id',msg.doc._id)===-1) {
									mdl.push(msg.doc);
								}
							break;
							case 'removed':
								mdl.splice(inColl(mdl,'_id',msg.doc._id),1);
								// delete mdl[msg.doc._id];
							break;
						}

						$scope.$apply();
					};
				}
			]);

			angular.bootstrap(document, [ 'bridgeTest' ]);
		</script>
	</body>
</html>